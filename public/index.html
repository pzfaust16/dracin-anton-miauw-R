const app = {
    activeId: null,
    currentEps: 0,
    allEpisodes: [],

    async init() {
        try {
            const res = await fetch('/api/dramabox/latest');
            const result = await res.json();
            
            // Mencoba berbagai kemungkinan struktur data API
            const data = result.data || result.chapterList || result; 

            if (Array.isArray(data)) {
                ui.render(data);
            } else {
                console.error("Data bukan array:", data);
            }
        } catch (e) { 
            console.error("Gagal ambil data:", e);
        }
    },

    // ... fungsi search tetap sama ...

    async openDetail(id) {
        ui.loader(true);
        try {
            const resDetail = await fetch(`/api/dramabox/detail?bookId=${id}`);
            const data = await resDetail.json();
            
            // Ambil data detail (Dramabox biasanya membungkus di result.data)
            const detail = data.data || data;

            document.getElementById('uiTitle').innerText = detail.bookName || "Judul Tidak Ada";
            document.getElementById('uiPoster').src = detail.cover || "";
            document.getElementById('uiDesc').innerText = detail.introduction || "Tidak ada deskripsi.";

            const resStream = await fetch(`/api/dramabox/linkstream?bookId=${id}`);
            const streamData = await resStream.json();
            this.allEpisodes = streamData.data || streamData;

            document.getElementById('episodeGrid').innerHTML = this.allEpisodes.map((ep, i) => `
                <button onclick="app.playEpisode(${i})" class="p-3 rounded-xl border border-white/5 bg-white/5 text-[10px] font-bold hover:bg-gradient-to-tr hover:from-[#EE4d2d] hover:to-[#ffca28] hover:text-black transition">
                    EPS ${i+1}
                </button>
            `).join('');

            ui.loader(false);
            ui.openDetail();
        } catch (e) { 
            ui.loader(false); 
            console.log(e);
        }
    },
    
    // ... fungsi playEpisode dll tetap sama ...
};

const ui = {
    render(data) {
        const grid = document.getElementById('movieGrid');
        grid.innerHTML = data.map(m => {
            // Cek apakah ada cover, jika tidak ada pakai placeholder
            const imgUrl = m.cover || m.bookCover || 'https://via.placeholder.com/300x450?text=No+Poster';
            const title = m.bookName || m.title || 'Untitled';
            
            return `
                <div class="movie-card rounded-[2rem] p-3 cursor-pointer group" onclick="app.openDetail('${m.bookId || m.id}')">
                    <div class="relative rounded-[1.5rem] overflow-hidden aspect-[2/3] mb-4 bg-white/5">
                        <img src="${imgUrl}" class="w-full h-full object-cover group-hover:scale-110 transition duration-700" onerror="this.src='https://via.placeholder.com/300x450?text=Error+Image'">
                        <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center text-2xl">â–¶</div>
                    </div>
                    <h4 class="font-bold text-sm truncate px-2 group-hover:text-gradient transition text-white">${title}</h4>
                </div>
            `;
        }).join('');
    },
    // ... sisanya tetap sama ...
};
